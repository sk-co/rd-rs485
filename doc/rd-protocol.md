# Протокол взаимодействия с РД

## Интерфейс

Устройство соединяется по двухпроводному интерфейсу RS485. Параметры соединения: скорость 19200 б/с, 8 бит, 1 стоповый, без контроля четности.



## Протокол

Сообщения состоят из заголовка и данных. По умолчанию формат передачи младшими байтами вперед ( little endian).

Если сообщение неверное (не совпала контрольная сумма, не те параметры и т.п.), то сообщение игнорируется устройством.



### Заголовок

-  **marker** (1 байт, беззнаковое) - 0xBC
-  **id** (4 байта, беззнаковое) - идентификатор устройства (серийный номер)
- **cmd** (1 байт, беззнаковое):
  - **answer_flag** (1 бит, старший) - флаг ответа, устанавливается в сообщениях от устройства
  - **cmd** (7 бит, младшие) - номер команды
- **size** (1 байта, беззнаковое) - длина данных команды (не включает заголовок)
- **crc** (2 байта, беззнаковое) - контрольная сумма всего сообщения, включая заголовок (без 
  маркера) и 
  данные. При вычислении значения crc обнуляется. Алгоритм расчета [CRC-16 CCITT (Poly 0x8408, Init: 0xFFFF, Revert: false, XorOut: 0x0000)](https://ru.wikibooks.org/wiki/%D0%A0%D0%B5%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8_%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC%D0%BE%D0%B2/%D0%A6%D0%B8%D0%BA%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9_%D0%B8%D0%B7%D0%B1%D1%8B%D1%82%D0%BE%D1%87%D0%BD%D1%8B%D0%B9_%D0%BA%D0%BE%D0%B4).

  

### Перечень команд

- 1 - **Info** - запрос информации об устройстве
- 2 - **Measurement** - запуск измерения и получение данных
- 3 - **ReadData** - получение сохраненных данных
- 4 - **ClearData** - удаление всех сохраненных данных
- 5 - **SetTime** - установка времени для устройства



### Команда Info

Запрос информации об устройстве. В заголовке запроса можно указать нулевое значение, либо **id** устройства.

Запрос: данных нет.

Ответ:

- **id** (4 байта, беззнаковое) - идентификатор устройства
- **channels_count** (1 байт, беззнаковое) - количество каналов
- **storage_capacity** (1 байт, беззнаковое) - размер хранилища значений
- **storage_size** (1 байт, беззнаковое) - количество данных в хранилище
- **error** (1 байт, беззнаковое) - статус устройства: 0 - все ОК, иначе значение ошибки
- **time_utc_ms** (8 байт, беззнаковое) - время устройства, UTC время в миллисекундах.

Значения ошибки (допишу по факту ближе к концу разработки):

- 0 - все ОК
- 1 - ошибка микросхемы RAM
- 2 - неизвестная ошибка


### Команда Measurement

Запуск измерения и получение данных измерения.

Запрос:

- **channel** (1 байт, беззнаковое) - номер канала, начинается с 1.

Ответ:

- **time_utc_ms** (8 байт, беззнаковое) - время измерений, UTC время в миллисекундах.
- **channel** (1 байт, беззнаковое) - номер канала, начинается с 1
- **frequency** (4 байта, float) - частота колебания струны тензометра
- **resistance** (4 байта, float) - сопротивление терморезистора в Омах
- **reason** (1 байт, беззнаковое) - причина измерения: 0 - запрос, 1 - измерения по сигналу



### Команда ReadData

Получение сохраненных в хранилище данных. Запрашивает диапазон данных, возвращает данные из 
хранилища, которые попали в диапазон. Максимальное количество передаваемых за один запрос данных 
14 измерений. Если запрашивается больше измерений, то выдаются первые 14. Если ни одни данные 
в запрашиваемый диапазон не входят, то возвращается ответ без **data**.

Запрос: 

- **first** (1 байт, беззнаковое) - номер первого измерения диапазона запрашиваемых данных, начинается с 1.
- **last** (1 байт, беззнаковое) - номер последнего измерения диапазона запрашиваемых данных

Ответ:

- **first** (1 байт, беззнаковое) - номер первого измерения диапазона возвращаемых данных
- **last** (1 байт, беззнаковое) - номер последнего измерения диапазона возвращаемых данных
- **data** (**count** * 18 байт) - массив измеренных значений, формат каждого значения такой же, как и в ответе на команду **Measurement**



### Команда ClearData

Удаление всех сохраненных данных.

Запрос: данных нет.

Ответ: данных нет.



### Команда SetTime

Установка времени в устройстве.

Запрос:

- **time_utc_ms** (8 байт, беззнаковое) - устанавливаемое время, UTC время в миллисекундах.

Ответ:

- **time_utc_ms** (8 байт, беззнаковое) - время устройства после установки, UTC время в миллисекундах.





